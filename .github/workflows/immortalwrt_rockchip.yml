name: immortalwrt_rockchip

on:
  # schedule:
  #   - cron: 0 16 * * *
  workflow_dispatch:
    inputs:
      build_all:
        description: 'Build all devices'
        required: false
        type: boolean
        default: true
      armsom_sige3:
        description: 'ArmSoM Sige3'
        required: false
        type: boolean
        default: false
      armsom_sige7:
        description: 'ArmSoM Sige7'
        required: false
        type: boolean
        default: false
      embedfire_doornet1:
        description: 'Embedfire DoorNet1'
        required: false
        type: boolean
        default: false
      embedfire_doornet2:
        description: 'Embedfire DoorNet2'
        required: false
        type: boolean
        default: false
      embedfire_lubancat_1:
        description: 'Embedfire LubanCat-1'
        required: false
        type: boolean
        default: false
      embedfire_lubancat_1n:
        description: 'Embedfire LubanCat-1N'
        required: false
        type: boolean
        default: false
      embedfire_lubancat_2:
        description: 'Embedfire LubanCat-2'
        required: false
        type: boolean
        default: false
      embedfire_lubancat_2n:
        description: 'Embedfire LubanCat-2N'
        required: false
        type: boolean
        default: false
      embedfire_lubancat_4:
        description: 'Embedfire LubanCat-4'
        required: false
        type: boolean
        default: false
      embedfire_lubancat_5:
        description: 'Embedfire LubanCat-5'
        required: false
        type: boolean
        default: false
      friendlyarm_nanopc_t4:
        description: 'FriendlyARM NanoPC-T4'
        required: false
        type: boolean
        default: false
      friendlyarm_nanopc_t6:
        description: 'FriendlyARM NanoPC-T6'
        required: false
        type: boolean
        default: false
      friendlyarm_nanopi_r2c:
        description: 'FriendlyARM NanoPi-R2C'
        required: false
        type: boolean
        default: false
      friendlyarm_nanopi_r2s:
        description: 'FriendlyARM NanoPi-R2S'
        required: false
        type: boolean
        default: false
      friendlyarm_nanopi_r3s:
        description: 'FriendlyARM NanoPi-R3S'
        required: false
        type: boolean
        default: false
      friendlyarm_nanopi_r4s:
        description: 'FriendlyARM NanoPi-R4S'
        required: false
        type: boolean
        default: false
      friendlyarm_nanopi_r4se:
        description: 'FriendlyARM NanoPi-R4SE'
        required: false
        type: boolean
        default: false
      friendlyarm_nanopi_r5c:
        description: 'FriendlyARM NanoPi-R5C'
        required: false
        type: boolean
        default: false
      friendlyarm_nanopi_r5s:
        description: 'FriendlyARM NanoPi-R5S'
        required: false
        type: boolean
        default: false
      friendlyarm_nanopi_r6c:
        description: 'FriendlyARM NanoPi-R6C'
        required: false
        type: boolean
        default: false
      friendlyarm_nanopi_r6s:
        description: 'FriendlyARM NanoPi-R6S'
        required: false
        type: boolean
        default: false
      hinlink_h88k:
        description: 'Hinlink H88K'
        required: false
        type: boolean
        default: false
      hinlink_opc_h66k:
        description: 'Hinlink OPC-H66K'
        required: false
        type: boolean
        default: false
      hinlink_opc_h68k:
        description: 'Hinlink OPC-H68K'
        required: false
        type: boolean
        default: false
      hinlink_opc_h69k:
        description: 'Hinlink OPC-H69K'
        required: false
        type: boolean
        default: false
      radxa_rock_5a:
        description: 'Radxa Rock-5A'
        required: false
        type: boolean
        default: false
      radxa_rock_5b:
        description: 'Radxa Rock-5B'
        required: false
        type: boolean
        default: false
      xunlong_orangepi_5:
        description: 'Xunlong OrangePi-5'
        required: false
        type: boolean
        default: false
      xunlong_orangepi_5_plus:
        description: 'Xunlong OrangePi-5 Plus'
        required: false
        type: boolean
        default: false

env:
  REPO_URL: https://github.com/DHDAXCW/immortalwrt
  REPO_BRANCH: openwrt-24.10
  CONFIG_FILE: immortalwrt/rockchip/defconfig
  DIY_P1_SH: immortalwrt/diy-part1.sh
  DIY_P2_SH: immortalwrt/diy-part2.sh
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  OPENWRT_NAME: immortalwrt
  OPENWRT_NAME1: rockchip

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Maximize build space
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 512
        swap-size-mb: 1024
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'

    - name: Check out the project branch
      uses: actions/checkout@main
      with:
          fetch-depth: 0

    - name: Clean build caches
      run: |
        echo "Cleaning previous build artifacts and caches..."
        sudo rm -rf $GITHUB_WORKSPACE/openwrt || true
        sudo rm -rf $RUNNER_TEMP/* || true
        sudo rm -rf $RUNNER_TOOL_CACHE/* || true
        sudo apt-get -qq clean || true
        sudo rm -rf /var/lib/apt/lists/* || true
        rm -rf ~/.cache/* || true
        echo "Cache cleanup complete."

    - name: Initialize the compilation environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        ( sudo -E apt-get -qq update
        sudo apt install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache clang cmake cpio curl device-tree-compiler ecj fastjar flex gawk gettext gcc-multilib \
            g++-multilib git gnutls-dev gperf haveged help2man intltool lib32gcc-s1 libc6-dev-i386 libelf-dev \
            libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses-dev libpython3-dev \
            libreadline-dev libssl-dev libtool libyaml-dev libz-dev lld llvm lrzsz mkisofs msmtp nano \
            ninja-build p7zip p7zip-full patch pkgconf python3 python3-pip python3-ply python3-docutils \
            python3-pyelftools qemu-utils re2c rsync scons squashfs-tools subversion swig texinfo uglifyjs \
            upx-ucl unzip vim wget xmlto xxd zlib1g-dev zstd
        sudo -E apt-get -qq purge azure-cli ghc* zulu* hhvm llvm* firefox powershell openjdk* dotnet* google* mysql* php* android* rename speedtest-cli
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean ) &
        sudo timedatectl set-timezone "$TZ"

    - name: Initialize Environment and Display System Info
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        chmod +x $OPENWRT_NAME/*.sh
        $GITHUB_WORKSPACE/$OPENWRT_NAME/system-Information.sh

    - name: Download firmware source code
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt

    - name: Update & install feeds
      working-directory: ./openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Load feeds.conf.default
      run: |
        chmod +x $OPENWRT_NAME/*.sh
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P1_SH

    - name: Load config
      run: |
        [ -e "$CONFIG_FILE" ] && cat "$CONFIG_FILE" > openwrt/.config
        chmod +x $OPENWRT_NAME/*.sh && cd openwrt
        $GITHUB_WORKSPACE/$DIY_P2_SH

    - name: Configure target device
      run: |
        cd openwrt
        
        # Build device list from checkbox inputs
        DEVICES=""
        
        if [ "${{ github.event.inputs.build_all }}" = "true" ]; then
          echo "Building all devices (MULTI_PROFILE)"
          DEVICES="all"
        else
          # Collect selected devices
          [ "${{ github.event.inputs.armsom_sige3 }}" = "true" ] && DEVICES="${DEVICES}armsom_sige3,"
          [ "${{ github.event.inputs.armsom_sige7 }}" = "true" ] && DEVICES="${DEVICES}armsom_sige7,"
          [ "${{ github.event.inputs.embedfire_doornet1 }}" = "true" ] && DEVICES="${DEVICES}embedfire_doornet1,"
          [ "${{ github.event.inputs.embedfire_doornet2 }}" = "true" ] && DEVICES="${DEVICES}embedfire_doornet2,"
          [ "${{ github.event.inputs.embedfire_lubancat_1 }}" = "true" ] && DEVICES="${DEVICES}embedfire_lubancat-1,"
          [ "${{ github.event.inputs.embedfire_lubancat_1n }}" = "true" ] && DEVICES="${DEVICES}embedfire_lubancat-1n,"
          [ "${{ github.event.inputs.embedfire_lubancat_2 }}" = "true" ] && DEVICES="${DEVICES}embedfire_lubancat-2,"
          [ "${{ github.event.inputs.embedfire_lubancat_2n }}" = "true" ] && DEVICES="${DEVICES}embedfire_lubancat-2n,"
          [ "${{ github.event.inputs.embedfire_lubancat_4 }}" = "true" ] && DEVICES="${DEVICES}embedfire_lubancat-4,"
          [ "${{ github.event.inputs.embedfire_lubancat_5 }}" = "true" ] && DEVICES="${DEVICES}embedfire_lubancat-5,"
          [ "${{ github.event.inputs.friendlyarm_nanopc_t4 }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopc-t4,"
          [ "${{ github.event.inputs.friendlyarm_nanopc_t6 }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopc-t6,"
          [ "${{ github.event.inputs.friendlyarm_nanopi_r2c }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopi-r2c,"
          [ "${{ github.event.inputs.friendlyarm_nanopi_r2s }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopi-r2s,"
          [ "${{ github.event.inputs.friendlyarm_nanopi_r3s }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopi-r3s,"
          [ "${{ github.event.inputs.friendlyarm_nanopi_r4s }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopi-r4s,"
          [ "${{ github.event.inputs.friendlyarm_nanopi_r4se }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopi-r4se,"
          [ "${{ github.event.inputs.friendlyarm_nanopi_r5c }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopi-r5c,"
          [ "${{ github.event.inputs.friendlyarm_nanopi_r5s }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopi-r5s,"
          [ "${{ github.event.inputs.friendlyarm_nanopi_r6c }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopi-r6c,"
          [ "${{ github.event.inputs.friendlyarm_nanopi_r6s }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopi-r6s,"
          [ "${{ github.event.inputs.hinlink_h88k }}" = "true" ] && DEVICES="${DEVICES}hinlink_h88k,"
          [ "${{ github.event.inputs.hinlink_opc_h66k }}" = "true" ] && DEVICES="${DEVICES}hinlink_opc-h66k,"
          [ "${{ github.event.inputs.hinlink_opc_h68k }}" = "true" ] && DEVICES="${DEVICES}hinlink_opc-h68k,"
          [ "${{ github.event.inputs.hinlink_opc_h69k }}" = "true" ] && DEVICES="${DEVICES}hinlink_opc-h69k,"
          [ "${{ github.event.inputs.radxa_rock_5a }}" = "true" ] && DEVICES="${DEVICES}radxa_rock-5a,"
          [ "${{ github.event.inputs.radxa_rock_5b }}" = "true" ] && DEVICES="${DEVICES}radxa_rock-5b,"
          [ "${{ github.event.inputs.xunlong_orangepi_5 }}" = "true" ] && DEVICES="${DEVICES}xunlong_orangepi-5,"
          [ "${{ github.event.inputs.xunlong_orangepi_5_plus }}" = "true" ] && DEVICES="${DEVICES}xunlong_orangepi-5-plus,"
          
          # Remove trailing comma
          DEVICES="${DEVICES%,}"
          
          if [ -z "$DEVICES" ]; then
            echo "Error: No devices selected. Please select at least one device or enable 'Build all devices'."
            exit 1
          fi
        fi

        if [ "$DEVICES" = "all" ]; then
          echo "Building all devices (MULTI_PROFILE)"
        else
          echo "Configuring for selected devices: $DEVICES"
          # Remove MULTI_PROFILE setting
          sed -i '/CONFIG_TARGET_MULTI_PROFILE=y/d' .config
          # Disable all device profiles first
          sed -i 's/CONFIG_TARGET_DEVICE_rockchip_armv8_DEVICE_.*=y/# & is not set/g' .config

          # Enable selected devices (comma-separated)
          IFS=',' read -ra DEVICE_ARRAY <<< "$DEVICES"
          for device in "${DEVICE_ARRAY[@]}"; do
            # Trim whitespace
            device=$(echo "$device" | xargs)
            DEVICE_CONFIG="CONFIG_TARGET_DEVICE_rockchip_armv8_DEVICE_${device}=y"
            echo "Enabling device: $device"
            sed -i "s/# ${DEVICE_CONFIG} is not set/${DEVICE_CONFIG}/g" .config
            # If device wasn't in the list, add it
            if ! grep -q "${DEVICE_CONFIG}" .config; then
              echo "${DEVICE_CONFIG}" >> .config
            fi
          done

          # If multiple devices selected, enable MULTI_PROFILE
          if [ ${#DEVICE_ARRAY[@]} -gt 1 ]; then
            echo "Multiple devices selected, enabling MULTI_PROFILE"
            sed -i '/CONFIG_TARGET_rockchip_armv8=y/a CONFIG_TARGET_MULTI_PROFILE=y' .config
          fi

          echo "Device configuration applied"
        fi

    - name: Download the installation package
      id: package
      run: |
        cd openwrt
        make defconfig
        make download -j$(nproc)
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: Compile the firmware
      id: compile
      run: |
        echo "date1=$(date +'%Y.%m.%d')" >> $GITHUB_ENV
        echo "date2=$(date "+%Yå¹´%mæœˆ%dæ—¥")" >> $GITHUB_ENV
        
        # Build device list from checkbox inputs
        DEVICES=""
        
        if [ "${{ github.event.inputs.build_all }}" = "true" ]; then
          DEVICES="all"
        else
          # Collect selected devices
          [ "${{ github.event.inputs.armsom_sige3 }}" = "true" ] && DEVICES="${DEVICES}armsom_sige3,"
          [ "${{ github.event.inputs.armsom_sige7 }}" = "true" ] && DEVICES="${DEVICES}armsom_sige7,"
          [ "${{ github.event.inputs.embedfire_doornet1 }}" = "true" ] && DEVICES="${DEVICES}embedfire_doornet1,"
          [ "${{ github.event.inputs.embedfire_doornet2 }}" = "true" ] && DEVICES="${DEVICES}embedfire_doornet2,"
          [ "${{ github.event.inputs.embedfire_lubancat_1 }}" = "true" ] && DEVICES="${DEVICES}embedfire_lubancat-1,"
          [ "${{ github.event.inputs.embedfire_lubancat_1n }}" = "true" ] && DEVICES="${DEVICES}embedfire_lubancat-1n,"
          [ "${{ github.event.inputs.embedfire_lubancat_2 }}" = "true" ] && DEVICES="${DEVICES}embedfire_lubancat-2,"
          [ "${{ github.event.inputs.embedfire_lubancat_2n }}" = "true" ] && DEVICES="${DEVICES}embedfire_lubancat-2n,"
          [ "${{ github.event.inputs.embedfire_lubancat_4 }}" = "true" ] && DEVICES="${DEVICES}embedfire_lubancat-4,"
          [ "${{ github.event.inputs.embedfire_lubancat_5 }}" = "true" ] && DEVICES="${DEVICES}embedfire_lubancat-5,"
          [ "${{ github.event.inputs.friendlyarm_nanopc_t4 }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopc-t4,"
          [ "${{ github.event.inputs.friendlyarm_nanopc_t6 }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopc-t6,"
          [ "${{ github.event.inputs.friendlyarm_nanopi_r2c }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopi-r2c,"
          [ "${{ github.event.inputs.friendlyarm_nanopi_r2s }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopi-r2s,"
          [ "${{ github.event.inputs.friendlyarm_nanopi_r3s }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopi-r3s,"
          [ "${{ github.event.inputs.friendlyarm_nanopi_r4s }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopi-r4s,"
          [ "${{ github.event.inputs.friendlyarm_nanopi_r4se }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopi-r4se,"
          [ "${{ github.event.inputs.friendlyarm_nanopi_r5c }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopi-r5c,"
          [ "${{ github.event.inputs.friendlyarm_nanopi_r5s }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopi-r5s,"
          [ "${{ github.event.inputs.friendlyarm_nanopi_r6c }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopi-r6c,"
          [ "${{ github.event.inputs.friendlyarm_nanopi_r6s }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopi-r6s,"
          [ "${{ github.event.inputs.hinlink_h88k }}" = "true" ] && DEVICES="${DEVICES}hinlink_h88k,"
          [ "${{ github.event.inputs.hinlink_opc_h66k }}" = "true" ] && DEVICES="${DEVICES}hinlink_opc-h66k,"
          [ "${{ github.event.inputs.hinlink_opc_h68k }}" = "true" ] && DEVICES="${DEVICES}hinlink_opc-h68k,"
          [ "${{ github.event.inputs.hinlink_opc_h69k }}" = "true" ] && DEVICES="${DEVICES}hinlink_opc-h69k,"
          [ "${{ github.event.inputs.radxa_rock_5a }}" = "true" ] && DEVICES="${DEVICES}radxa_rock-5a,"
          [ "${{ github.event.inputs.radxa_rock_5b }}" = "true" ] && DEVICES="${DEVICES}radxa_rock-5b,"
          [ "${{ github.event.inputs.xunlong_orangepi_5 }}" = "true" ] && DEVICES="${DEVICES}xunlong_orangepi-5,"
          [ "${{ github.event.inputs.xunlong_orangepi_5_plus }}" = "true" ] && DEVICES="${DEVICES}xunlong_orangepi-5-plus,"
          
          # Remove trailing comma
          DEVICES="${DEVICES%,}"
        fi
        
        if [ "$DEVICES" != "all" ]; then
          # Create a clean suffix from device list
          SUFFIX=$(echo "$DEVICES" | tr ',' '_' | sed 's/[[:space:]]//g')
          echo "device_suffix=_${SUFFIX}" >> $GITHUB_ENV
        else
          echo "device_suffix=" >> $GITHUB_ENV
        fi
        cd openwrt
        echo -e "$(nproc) thread compile"
        make -j$(nproc) || make -j1 || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Organize and Rename Files
      id: organize
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd openwrt/bin/targets/rockchip/armv8
        rm -rf packages *.buildinfo *.manifest *.json
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload the firmware to github
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: ${{ env.date1 }}_${{ env.OPENWRT_NAME }}_${{ env.OPENWRT_NAME1 }}${{ env.device_suffix }}
        path: ${{ env.FIRMWARE }}

    - name: Generate release tags
      id: tag
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        # Build device list from checkbox inputs
        DEVICES=""
        
        if [ "${{ github.event.inputs.build_all }}" = "true" ]; then
          DEVICES="all"
        else
          # Collect selected devices
          [ "${{ github.event.inputs.armsom_sige3 }}" = "true" ] && DEVICES="${DEVICES}armsom_sige3,"
          [ "${{ github.event.inputs.armsom_sige7 }}" = "true" ] && DEVICES="${DEVICES}armsom_sige7,"
          [ "${{ github.event.inputs.embedfire_doornet1 }}" = "true" ] && DEVICES="${DEVICES}embedfire_doornet1,"
          [ "${{ github.event.inputs.embedfire_doornet2 }}" = "true" ] && DEVICES="${DEVICES}embedfire_doornet2,"
          [ "${{ github.event.inputs.embedfire_lubancat_1 }}" = "true" ] && DEVICES="${DEVICES}embedfire_lubancat-1,"
          [ "${{ github.event.inputs.embedfire_lubancat_1n }}" = "true" ] && DEVICES="${DEVICES}embedfire_lubancat-1n,"
          [ "${{ github.event.inputs.embedfire_lubancat_2 }}" = "true" ] && DEVICES="${DEVICES}embedfire_lubancat-2,"
          [ "${{ github.event.inputs.embedfire_lubancat_2n }}" = "true" ] && DEVICES="${DEVICES}embedfire_lubancat-2n,"
          [ "${{ github.event.inputs.embedfire_lubancat_4 }}" = "true" ] && DEVICES="${DEVICES}embedfire_lubancat-4,"
          [ "${{ github.event.inputs.embedfire_lubancat_5 }}" = "true" ] && DEVICES="${DEVICES}embedfire_lubancat-5,"
          [ "${{ github.event.inputs.friendlyarm_nanopc_t4 }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopc-t4,"
          [ "${{ github.event.inputs.friendlyarm_nanopc_t6 }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopc-t6,"
          [ "${{ github.event.inputs.friendlyarm_nanopi_r2c }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopi-r2c,"
          [ "${{ github.event.inputs.friendlyarm_nanopi_r2s }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopi-r2s,"
          [ "${{ github.event.inputs.friendlyarm_nanopi_r3s }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopi-r3s,"
          [ "${{ github.event.inputs.friendlyarm_nanopi_r4s }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopi-r4s,"
          [ "${{ github.event.inputs.friendlyarm_nanopi_r4se }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopi-r4se,"
          [ "${{ github.event.inputs.friendlyarm_nanopi_r5c }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopi-r5c,"
          [ "${{ github.event.inputs.friendlyarm_nanopi_r5s }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopi-r5s,"
          [ "${{ github.event.inputs.friendlyarm_nanopi_r6c }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopi-r6c,"
          [ "${{ github.event.inputs.friendlyarm_nanopi_r6s }}" = "true" ] && DEVICES="${DEVICES}friendlyarm_nanopi-r6s,"
          [ "${{ github.event.inputs.hinlink_h88k }}" = "true" ] && DEVICES="${DEVICES}hinlink_h88k,"
          [ "${{ github.event.inputs.hinlink_opc_h66k }}" = "true" ] && DEVICES="${DEVICES}hinlink_opc-h66k,"
          [ "${{ github.event.inputs.hinlink_opc_h68k }}" = "true" ] && DEVICES="${DEVICES}hinlink_opc-h68k,"
          [ "${{ github.event.inputs.hinlink_opc_h69k }}" = "true" ] && DEVICES="${DEVICES}hinlink_opc-h69k,"
          [ "${{ github.event.inputs.radxa_rock_5a }}" = "true" ] && DEVICES="${DEVICES}radxa_rock-5a,"
          [ "${{ github.event.inputs.radxa_rock_5b }}" = "true" ] && DEVICES="${DEVICES}radxa_rock-5b,"
          [ "${{ github.event.inputs.xunlong_orangepi_5 }}" = "true" ] && DEVICES="${DEVICES}xunlong_orangepi-5,"
          [ "${{ github.event.inputs.xunlong_orangepi_5_plus }}" = "true" ] && DEVICES="${DEVICES}xunlong_orangepi-5-plus,"
          
          # Remove trailing comma
          DEVICES="${DEVICES%,}"
        fi
        
        if [ "$DEVICES" != "all" ]; then
          # Create a clean tag from device list
          TAG_SUFFIX=$(echo "$DEVICES" | tr ',' '_' | sed 's/[[:space:]]//g')
          echo "release_tag=${{ env.date1 }}_${TAG_SUFFIX}" >> $GITHUB_OUTPUT
          echo "release_name=${{ env.date2 }} - ${DEVICES}" >> $GITHUB_OUTPUT
        else
          echo "release_tag=${{ env.date1 }}" >> $GITHUB_OUTPUT
          echo "release_name=${{ env.date2 }}" >> $GITHUB_OUTPUT
        fi
        touch release.txt
        echo "ðŸ“¥ å›ºä»¶ä¸‹è½½" >> release.txt
        if [ "$DEVICES" != "all" ]; then
          echo "ðŸŽ¯ ç›®æ ‡è®¾å¤‡: ${DEVICES}" >> release.txt
        else
          echo "ðŸŽ¯ ç›®æ ‡è®¾å¤‡: å…¨éƒ¨è®¾å¤‡ (Multi-Profile)" >> release.txt
        fi
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Publish to release
      uses: softprops/action-gh-release@v1
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: ${{ env.FIRMWARE }}/*
        name: ${{ steps.tag.outputs.release_name }}
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
